#!/sbin/openrc-run

name=$RC_SVCNAME
description="Seaman App Service"
command="/root/middleware/sm_speaker_test/run.sh"
command_user="root"
pidfile="/run/$RC_SVCNAME.pid"
command_background="yes"
directory="/root/middleware/sm_speaker_test"

depend() {
    need net seaman-daemon
    after bootmisc
}

start_pre() {
    until curl -si http://localhost:8080 -d '{}' | grep "200 OK"; do sleep 1; done
    
    mkdir -p /root/middleware/sm_speaker_test/assets/{audio,font,gifs,images,trigger}
    
    cp -r /media/mmcblk0p1/seaman/speaker/* /root/middleware/sm_speaker_test/
    chmod -R 755 /root/middleware/sm_speaker_test

    mkdir -p /root/.ssh
    cp -r /media/mmcblk0p1/seaman/.ssh/* /root/.ssh/
    chmod 700 /root/.ssh
    chmod 600 /root/.ssh/id_ed25519
    chmod 644 /root/.ssh/id_ed25519.pub

    # Create and setup venv
    python3 -m venv /root/middleware/sm_speaker_test/.venv
    source /root/middleware/sm_speaker_test/.venv/bin/activate
    pip install --no-cache-dir schedule openai numpy google-cloud pyaudio
    
    if [ -d "/media/mmcblk0p1/seaman/.ssh" ]; then
        mkdir -p /root/middleware/.ssh
        cp -r /media/mmcblk0p1/seaman/.ssh/* /root/middleware/.ssh/
        chmod 700 /root/middleware/.ssh
        chmod 600 /root/middleware/.ssh/id_ed25519
        chmod 644 /root/middleware/.ssh/id_ed25519.pub
    fi
}

stop_post() {
    # Remove lock file
    rm -f /tmp/audio_device.lock
    
    # Clean up any remaining audio processes
    fuser -k /dev/snd/* 2>/dev/null || true
    pulseaudio --kill 2>/dev/null || true
    
    # Give a moment for cleanup to complete
    sleep 2
}